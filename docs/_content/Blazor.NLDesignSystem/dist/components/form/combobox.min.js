/*!
NL Design System Componenten library 0.1.1, build date 27-06-2020
Copyright 2011-2020 The NL Design System Authors
Copyright 2011-2020 Duo
Author: DUO & The NL Design System Authors
Author URI: https://nl-design-system.gitlab.io/nl-design-system/
License: EUPL v1.2
License URL: https://joinup.ec.europa.eu/software/page/eupl5
Version: 0.1.1
*/
var utils_1=require("../../core/utils"),ITEM_TEMPLATE='<li role="button" tabindex="-1" class="combobox__item">\n    <span class="combobox__link">%s</span>\n </li>',NO_RESULT_TEMPLATE='<li tabindex="-1" class="combobox__item combobox__item--no-results" hidden>\n <span class="combobox__link">Geen resultaten gevonden.</span>\n</li>',ITEM_COMBOBOX_TEMPLATE='<li class="input__group input__group--compact input__group--checkbox" role="group">\n<input role=checkbox type="checkbox" id="chkbx-compact-$id" class="input__control input__control--checkbox">\n<label class="input__label input__label--checkbox combobox__link" for="chkbx-compact-$id">$label</label>\n</li>',DATAFIELD="comboboxItem";exports.MODE_FILTER=1,exports.MODE_AUTOCOMPLETE=2;var Combobox=function(){function t(t,e){if(void 0===e&&(e=!1),this.host=t,this.isCheckboxFilter=e,this._allowUnknown=!0,this._filterFunction=this.defaultFilter,this._initTimeout=2,this._inputTimeout=100,this._labelFunction=this.defaultLabel,this._loading=!1,this._mode=exports.MODE_FILTER,this._validationError="Ongeldige invoer",this._value=null,this._filterContainer=null,this._highlight=!0,!t)throw new Error("No host element specified");this.setup(),this.setupListeners()}return Object.defineProperty(t.prototype,"allowUnknown",{get:function(){return this._allowUnknown},set:function(t){this._allowUnknown=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"data",{get:function(){return this._data},set:function(t){this._data=t,this.initialize()},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"filterFunction",{get:function(){return this._filterFunction},set:function(t){this._highlight=!1,this._filterFunction=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"inputTimeout",{get:function(){return this._inputTimeout},set:function(t){this._inputTimeout=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"labelField",{get:function(){return this._labelField},set:function(t){this._labelField=t,this.initialize()},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"labelFunction",{get:function(){return this._labelFunction},set:function(t){this._labelFunction=t,this.initialize()},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"loading",{get:function(){return this._loading},set:function(t){if(this._loading=t,this._icon){var e=t?"add":"remove";this._icon.classList[e]("combobox__icon--loading")}},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"mode",{get:function(){return this._mode},set:function(t){this._mode=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"validationError",{get:function(){return this._validationError},set:function(t){this._validationError=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"value",{get:function(){return this._value},set:function(t){if(!this.allowUnknown&&-1===this.data.indexOf(t))throw new Error("Unknown item '"+t.toString()+"'");this._value=t;var e=document.createElement("div");e.innerHTML=this.labelFunction(t),this._input.value=e.textContent},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"isOpen",{get:function(){return this.host.classList.contains("combobox--autocomplete-open")},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"query",{get:function(){return this._input?this._input.value:void 0},enumerable:!0,configurable:!0}),t.prototype.handleEvent=function(t){switch(t.currentTarget){case this._toggle:this["onToggle"+t.type](t);break;case this._list:this.isCheckboxFilter||this["onList"+t.type](t);break;case this._input:this["onInput"+t.type](t);break;case document.body:this["onBody"+t.type](t)}},t.prototype.open=function(){if(this.data){var t=document.createEvent("CustomEvent");t.initEvent("combobox-open",!0,!0),this.host.dispatchEvent(t)&&(this.isOpen||(this._prevQuery=null),this.host.classList.add("combobox--autocomplete-open"),this._list.hidden=!1,this.filterInput())}},t.prototype.close=function(){if(this.isOpen){var t=document.createEvent("CustomEvent");t.initEvent("combobox-close",!0,!0),this.host.dispatchEvent(t)&&(this.host.classList.remove("combobox--autocomplete-open"),this._list.hidden=!0)}},t.prototype.destroy=function(){this._toggle.removeEventListener("click",this),this._input.removeEventListener("keyup",this),this._input.removeEventListener("keydown",this),this._input.removeEventListener("input",this),this._list.removeEventListener("click",this),this._list.removeEventListener("keyup",this),this._list.removeEventListener("keydown",this),this._list.remove(),document.body.removeEventListener("click",this)},t.prototype.createListItems=function(){var o=this;this.isCheckboxFilter?this.data.forEach(function(t,i){var e=utils_1.Utils.CreateNode(ITEM_COMBOBOX_TEMPLATE.replace("$label",t.name).replace(/\$id/g,i.toString()));e[DATAFIELD]=t,e.querySelector("input").addEventListener("change",function(){o.buildFilterList()}),e.querySelector("input").addEventListener("keydown",function(t){if(utils_1.Utils.IsKeyPressed(t,"Escape")&&o.close(),utils_1.Utils.IsKeyPressed(t,"Tab")){var e=o._list.querySelectorAll("input");t.shiftKey?0===i&&o.close():i>=e.length-1&&o.close()}}),o._list.appendChild(e)}):this.data&&this.data.forEach(function(t){var e=o.labelFunction(t),i=utils_1.Utils.CreateNode(ITEM_TEMPLATE.split("%s").join(e));i[DATAFIELD]=t,o._list.appendChild(i)})},t.prototype.createNoResultItem=function(){var t=utils_1.Utils.CreateNode(NO_RESULT_TEMPLATE);this._list.appendChild(t)},t.prototype.defaultFilter=function(t,e){return this.isCheckboxFilter&&(t=t.name),-1<t.toString().toLowerCase().indexOf(this.query.toLowerCase())},t.prototype.defaultLabel=function(t,e){return"string"==typeof t?t:this.labelField&&t.hasOwnProperty(this.labelField)?t[this.labelField].toString():t.toString()},t.prototype.filterInput=function(){var r=this;this.data&&(window.clearTimeout(this._inputTimeoutId),this._inputTimeoutId=window.setTimeout(function(){r._prevQuery!==r.query&&(r._prevQuery=r.query,r.data.filter(function(t,e,i){var o=r._list.children[e],s=o.querySelector(".combobox__link"),n=r.filterFunction.call(r,t,e,i);return o.hidden=!0,n?(o.hidden=!1,r._highlight&&r.query&&(s.innerHTML=s.textContent.split(r.query).join('<span class="combobox__match">'+r.query+"</span>"))):r._highlight&&(s.nodeValue=s.textContent),n}).length?r.hideNoResultItem():r.showNoResultItem(),r.isOpen||r.open())},this.inputTimeout))},t.prototype.showNoResultItem=function(){this._list.querySelector(".combobox__item--no-results").hidden=!1,this._list.removeEventListener("click",this),this._list.removeEventListener("keyup",this),this._list.removeEventListener("keydown",this)},t.prototype.hideNoResultItem=function(){this._list.querySelector(".combobox__item--no-results").hidden=!0,this.isCheckboxFilter||this._list.addEventListener("click",this),this._list.addEventListener("keyup",this),this._list.addEventListener("keydown",this)},t.prototype.focusNextItem=function(t){void 0===t&&(t=1);var e=document.activeElement;if(e.classList.contains("combobox__item")&&utils_1.Utils.IsDescendant(e,this.host)){for(var i=1===t?"nextElementSibling":"previousElementSibling";e[i];)if(!(e=e[i]).hidden){e.focus();break}}else for(var o=this._list.querySelectorAll(".combobox__item"),s=0,n=o.length;s<n;s+=1){var r=o[s];if(!r.hasAttribute("hidden")){r.focus();break}}},t.prototype.initialize=function(){var t=this;clearTimeout(this._initTimeoutId),this._initTimeoutId=window.setTimeout(function(){t.removeListItems(),t.createListItems(),t.createNoResultItem(),t.mode===exports.MODE_AUTOCOMPLETE&&t.filterInput()},this._initTimeout)},t.prototype.onInputinput=function(){this.data&&!this.allowUnknown&&-1===this.data.indexOf(this._input.value)?this._input.setCustomValidity(this.validationError):this._input.setCustomValidity("")},t.prototype.onInputkeydown=function(t){t.stopPropagation()},t.prototype.onInputkeyup=function(t){if(utils_1.Utils.IsKeyPressed(t,"Escape"))return this.close();if(utils_1.Utils.IsKeyPressed(t,"ArrowDown")||utils_1.Utils.IsKeyPressed(t,"ArrowUp"))if(this.isOpen)this.focusNextItem(utils_1.Utils.IsKeyPressed(t,"ArrowDown")?1:-1);else{this.open();var e=this._list.querySelector(".combobox__item");e&&e.focus()}this.mode===exports.MODE_FILTER&&(this._value=null,this.filterInput())},t.prototype.onListclick=function(t){this.setValue(this.findDataField(t.target))},t.prototype.onBodyclick=function(t){if(t.target!==this._input&&t.target!==this._toggle&&t.target!==this._icon&&t.target!==this._list){if(this.isCheckboxFilter&&null!=this.findDataField(t.target))return;this.close()}},t.prototype.findDataField=function(t){for(;t&&!t[DATAFIELD];)t=t.parentElement;return t&&t[DATAFIELD]},t.prototype.onListkeydown=function(t){t.preventDefault(),t.stopPropagation()},t.prototype.onListkeyup=function(t){if(t.preventDefault(),utils_1.Utils.IsKeyPressed(t,"Escape"))this._value=null,this.close();else if(utils_1.Utils.IsKeyPressed(t,"ArrowDown")||utils_1.Utils.IsKeyPressed(t,"ArrowUp"))this.focusNextItem(utils_1.Utils.IsKeyPressed(t,"ArrowDown")?1:-1);else if(utils_1.Utils.IsKeyPressed(t,"Enter")){var e=document.activeElement;if(e.classList.contains("combobox__item")){var i=this.findDataField(e);this.setValue(i)}}},t.prototype.onToggleclick=function(t){this.isOpen?(this._value=null,this.close()):this.open()},t.prototype.updateFilterList=function(t){var e=this,i=this.getFilterContainer();i.innerHTML="";for(var o=0;o<t.length;o++){o;var s=utils_1.Utils.CreateNode('<li tabindex="0">'+t[o]+"</li>");s.id=o.toString(),s.addEventListener("click",function(t){return e.onFilterLabelClick(t.target)}),s.addEventListener("keyup",function(t){utils_1.Utils.IsKeyPressed(t,"Enter")&&e.onFilterLabelClick(t.target)}),i.appendChild(s)}},t.prototype.onFilterLabelClick=function(t){if(this.isCheckboxFilter){var e=t;this._list.querySelectorAll(".input__control:checked")[e.id].checked=!1;var i=this.getFilterContainer();if(this.buildFilterList(),0===i.querySelectorAll("li").length)this._input.focus();else{var o=0<parseInt(e.id)?parseInt(e.id)-1:0;i.querySelectorAll("li")[o].focus()}}},t.prototype.getFilterContainer=function(){return null===this._filterContainer&&(this._filterContainer=this.host.querySelector(".list--filter"),null===this._filterContainer&&(this._filterContainer=utils_1.Utils.CreateNode('<ul class="list list--filter list--filter-inline list--filter-closable" />'),this.host.insertBefore(this._filterContainer,this.host.querySelector(".combobox__input")))),this._filterContainer},t.prototype.buildFilterList=function(){this._value=[];for(var t=this._list.querySelectorAll(".input__control:checked"),e=0;e<t.length;e++)this._value.push(t[e].parentElement.querySelector(".input__label").textContent);this.updateFilterList(this._value)},t.prototype.setValue=function(t){var e=document.createEvent("CustomEvent");e.initEvent("combobox-select",!0,!0),e.data=t,!this.isCheckboxFilter&&this.host.dispatchEvent(e)&&(this.value=t,this.close())},t.prototype.setup=function(){if(!this.host.querySelector(".combobox__input"))throw new Error("Host element should contain a text input");if(this.host.classList.contains("combobox")||this.host.classList.add("combobox"),this.host.querySelector(".combobox__icon")||(this._icon=utils_1.Utils.CreateNode('<i class="combobox__icon icon icon-magnifier" role="presentation"></i>'),this.host.appendChild(this._icon)),this._toggle=this.host.querySelector(".combobox__toggle"),this._toggle||(this._toggle=utils_1.Utils.CreateNode('<button type="button" class="combobox__toggle"></button>'),this.host.appendChild(this._toggle)),!this.host.querySelector(".combobox__autocomplete")){var t=utils_1.Utils.CreateNode('<div class="combobox__autocomplete">\n                     <div class="combobox__list-wrapper">\n                         <ul class="combobox__list" tabindex="0" hidden>\n                         </ul>\n                     </div>\n                 </div>');this.host.appendChild(t)}if(this._list=this.host.querySelector(".combobox__list"),this.isCheckboxFilter){this._list.classList.add("combobox__list--multiple"),this._list.setAttribute("tabindex","-1");var e=this.host.querySelector(".combobox__input");this._data=[];for(var i=0;i<e.children.length;i++)this._data.push({name:e.children[i].textContent,value:""});var o=utils_1.Utils.CreateNode("<input />");o.className=e.className,this.host.replaceChild(o,e),this.createListItems(),this.createNoResultItem()}this._input=this.host.querySelector(".combobox__input")},t.prototype.setupListeners=function(){this._toggle.addEventListener("click",this),this._input.addEventListener("keyup",this),this._input.addEventListener("keydown",this),this._input.addEventListener("input",this),this.isCheckboxFilter||this._list.addEventListener("click",this),this._list.addEventListener("keyup",this),this._list.addEventListener("keydown",this),document.body.addEventListener("click",this)},t.prototype.removeListItems=function(){for(;this._list.lastChild;)this._list.removeChild(this._list.lastChild)},t}();exports.Combobox=Combobox;